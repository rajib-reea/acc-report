| #   | transaction_date | customer_id | reason     | total_credit_note_amount | overall_credit_note_amount |
|-----|------------------|-------------|------------|--------------------------|----------------------------|
| 1   | 2025-01-01       | 101         | Return     | 150.00                   | 2900.00                    |
| 2   | 2025-01-01       | 102         | Adjustment | 200.00                   | 2900.00                    |
| 3   | 2025-01-02       | 101         | Return     | 100.00                   | 2900.00                    |
| 4   | 2025-01-02       | 103         | Return     | 50.00                    | 2900.00                    |
| 5   | 2025-01-03       | 104         | Adjustment | 300.00                   | 2900.00                    |
| 6   | 2025-01-04       | 102         | Return     | 250.00                   | 2900.00                    |
| 7   | 2025-01-05       |             |            | 0                        | 2900.00                    |
| 8   | 2025-01-06       | 105         | Return     | 400.00                   | 2900.00                    |
| 9   | 2025-01-07       | 101         | Adjustment | 500.00                   | 2900.00                    |
| 10  | 2025-01-08       | 102         | Return     | 150.00                   | 2900.00                    |
| 11  | 2025-01-09       | 103         | Adjustment | 350.00                   | 2900.00                    |
| 12  | 2025-01-10       | 104         | Return     | 450.00                   | 2900.00                    |
| 13  | 2025-01-11       |             |            | 0                        | 2900.00                    |
| 14  | 2025-01-12       |             |            | 0                        | 2900.00                    |
| 15  | 2025-01-13       |             |            | 0                        | 2900.00                    |
| 16  | 2025-01-14       |             |            | 0                        | 2900.00                    |
| 17  | 2025-01-15       |             |            | 0                        | 2900.00                    |
| 18  | 2025-01-16       |             |            | 0                        | 2900.00                    |
| 19  | 2025-01-17       |             |            | 0                        | 2900.00                    |
| 20  | 2025-01-18       |             |            | 0                        | 2900.00                    |
| 21  | 2025-01-19       |             |            | 0                        | 2900.00                    |
| 22  | 2025-01-20       |             |            | 0                        | 2900.00                    |
| 23  | 2025-01-21       |             |            | 0                        | 2900.00                    |
| 24  | 2025-01-22       |             |            | 0                        | 2900.00                    |
| 25  | 2025-01-23       |             |            | 0                        | 2900.00                    |
| 26  | 2025-01-24       |             |            | 0                        | 2900.00                    |
| 27  | 2025-01-25       |             |            | 0                        | 2900.00                    |
| 28  | 2025-01-26       |             |            | 0                        | 2900.00                    |
| 29  | 2025-01-27       |             |            | 0                        | 2900.00                    |
| 30  | 2025-01-28       |             |            | 0                        | 2900.00                    |
| 31  | 2025-01-29       |             |            | 0                        | 2900.00                    |
| 32  | 2025-01-30       |             |            | 0                        | 2900.00                    |
| 33  | 2025-01-31       |             |            | 0                        | 2900.00                    |
| 34  | 2025-02-01       |             |            | 0                        | 2900.00                    |
| 35  | 2025-02-02       |             |            | 0                        | 2900.00                    |
| 36  | 2025-02-03       |             |            | 0                        | 2900.00                    |
| 37  | 2025-02-04       |             |            | 0                        | 2900.00                    |
| 38  | 2025-02-05       |             |            | 0                        | 2900.00                    |
| 39  | 2025-02-06       |             |            | 0                        | 2900.00                    |
| 40  | 2025-02-07       |             |            | 0                        | 2900.00                    |
| 41  | 2025-02-08       |             |            | 0                        | 2900.00                    |
| 42  | 2025-02-09       |             |            | 0                        | 2900.00                    |
| 43  | 2025-02-10       |             |            | 0                        | 2900.00                    |
| 44  | 2025-02-11       |             |            | 0                        | 2900.00                    |
| 45  | 2025-02-12       |             |            | 0                        | 2900.00                    |
| 46  | 2025-02-13       |             |            | 0                        | 2900.00                    |
| 47  | 2025-02-14       |             |            | 0                        | 2900.00                    |
| 48  | 2025-02-15       |             |            | 0                        | 2900.00                    |
| 49  | 2025-02-16       |             |            | 0                        | 2900.00                    |
| 50  | 2025-02-17       |             |            | 0                        | 2900.00                    |
| 51  | 2025-02-18       |             |            | 0                        | 2900.00                    |
| 52  | 2025-02-19       |             |            | 0                        | 2900.00                    |
| 53  | 2025-02-20       |             |            | 0                        | 2900.00                    |
| 54  | 2025-02-21       |             |            | 0                        | 2900.00                    |
| 55  | 2025-02-22       |             |            | 0                        | 2900.00                    |
| 56  | 2025-02-23       |             |            | 0                        | 2900.00                    |
| 57  | 2025-02-24       |             |            | 0                        | 2900.00                    |
| 58  | 2025-02-25       |             |            | 0                        | 2900.00                    |
| 59  | 2025-02-26       |             |            | 0                        | 2900.00                    |
| 60  | 2025-02-27       |             |            | 0                        | 2900.00                    |
| 61  | 2025-02-28       |             |            | 0                        | 2900.00                    |
| 62  | 2025-03-01       |             |            | 0                        | 2900.00                    |
| 63  | 2025-03-02       |             |            | 0                        | 2900.00                    |
| 64  | 2025-03-03       |             |            | 0                        | 2900.00                    |
| 65  | 2025-03-04       |             |            | 0                        | 2900.00                    |
| 66  | 2025-03-05       |             |            | 0                        | 2900.00                    |
| 67  | 2025-03-06       |             |            | 0                        | 2900.00                    |
| 68  | 2025-03-07       |             |            | 0                        | 2900.00                    |
| 69  | 2025-03-08       |             |            | 0                        | 2900.00                    |
| 70  | 2025-03-09       |             |            | 0                        | 2900.00                    |
| 71  | 2025-03-10       |             |            | 0                        | 2900.00                    |
| 72  | 2025-03-11       |             |            | 0                        | 2900.00                    |
| 73  | 2025-03-12       |             |            | 0                        | 2900.00                    |
| 74  | 2025-03-13       |             |            | 0                        | 2900.00                    |
| 75  | 2025-03-14       |             |            | 0                        | 2900.00                    |
| 76  | 2025-03-15       |             |            | 0                        | 2900.00                    |
| 77  | 2025-03-16       |             |            | 0                        | 2900.00                    |
| 78  | 2025-03-17       |             |            | 0                        | 2900.00                    |
| 79  | 2025-03-18       |             |            | 0                        | 2900.00                    |
| 80  | 2025-03-19       |             |            | 0                        | 2900.00                    |
| 81  | 2025-03-20       |             |            | 0                        | 2900.00                    |
| 82  | 2025-03-21       |             |            | 0                        | 2900.00                    |
| 83  | 2025-03-22       |             |            | 0                        | 2900.00                    |
| 84  | 2025-03-23       |             |            | 0                        | 2900.00                    |
| 85  | 2025-03-24       |             |            | 0                        | 2900.00                    |
| 86  | 2025-03-25       |             |            | 0                        | 2900.00                    |
| 87  | 2025-03-26       |             |            | 0                        | 2900.00                    |
| 88  | 2025-03-27       |             |            | 0                        | 2900.00                    |
| 89  | 2025-03-28       |             |            | 0                        | 2900.00                    |
| 90  | 2025-03-29       |             |            | 0                        | 2900.00                    |
| 91  | 2025-03-30       |             |            | 0                        | 2900.00                    |
| 92  | 2025-03-31       |             |            | 0                        | 2900.00                    |
| 93  | 2025-04-01       |             |            | 0                        | 2900.00                    |
| 94  | 2025-04-02       |             |            | 0                        | 2900.00                    |
| 95  | 2025-04-03       |             |            | 0                        | 2900.00                    |
| 96  | 2025-04-04       |             |            | 0                        | 2900.00                    |
| 97  | 2025-04-05       |             |            | 0                        | 2900.00                    |
| 98  | 2025-04-06       |             |            | 0                        | 2900.00                    |
| 99  | 2025-04-07       |             |            | 0                        | 2900.00                    |
| 100 | 2025-04-08       |             |            | 0                        | 2900.00                    |

Algorithm:
Credit_Note_Transactions_Report(startDate, endDate):
  1. Retrieve all credit note transactions within the specified date range (startDate to endDate).
  2. Group the credit note transactions by customer.
  3. For each transaction, calculate the total credit note amount issued.
  4. Optionally, group the credit note transactions by reason (e.g., returns, adjustments).
  5. Calculate the overall total value of credit notes issued within the specified period.
  6. Validate the credit note amounts (ensure no invalid or negative values).
  7. Store the credit note transaction data and return the results.

SQL:
-- Step 1: Generate the date series for daily reporting
WITH DateSeries AS (
    SELECT generate_series(
        '2025-01-01'::DATE, 
        '2025-12-31'::DATE, 
        INTERVAL '1 day'
    )::DATE AS transaction_date
),
CreditNoteTransactions AS (
    -- Step 2: Retrieve all valid credit note transactions within the specified date range
    SELECT
        cn.transaction_id,
        cn.customer_id,
        cn.transaction_date,
        cn.reason,  -- Optional: Group by reason such as returns, adjustments, etc.
        cn.amount AS credit_note_amount
    FROM acc_credit_notes cn
    WHERE cn.transaction_date BETWEEN (SELECT MIN(transaction_date) FROM DateSeries)
                                  AND (SELECT MAX(transaction_date) FROM DateSeries)
      AND cn.amount > 0  -- Step 3: Filter out invalid or negative credit note amounts
),
AggregatedCreditNotes AS (
    -- Step 4 & 5: Group by customer, reason, and date; calculate total per day
    SELECT
        ds.transaction_date,
        cnt.customer_id,
        cnt.reason,
        COALESCE(SUM(cnt.credit_note_amount), 0) AS total_credit_note_amount
    FROM DateSeries ds
    LEFT JOIN CreditNoteTransactions cnt
        ON ds.transaction_date = cnt.transaction_date
    GROUP BY ds.transaction_date, cnt.customer_id, cnt.reason
),
OverallCreditNotes AS (
    -- Step 6: Calculate the overall total credit note value issued
    SELECT
        SUM(credit_note_amount) AS overall_credit_note_amount
    FROM CreditNoteTransactions
)

-- Step 7 & 8: Return the daily data with overall totals
SELECT
    acn.transaction_date,
    acn.customer_id,
    acn.reason,
    acn.total_credit_note_amount,
    ocn.overall_credit_note_amount
FROM AggregatedCreditNotes acn
CROSS JOIN OverallCreditNotes ocn
ORDER BY acn.transaction_date, acn.customer_id, acn.reason;
